#!/bin/bash

ip=$1
mac=$2

USERS="/var/lib/innproxy/users.json"

echo "awaiting auth for $ip,$mac"
stamp=$(date +%s)
sfile="/tmp/auth-$ip"
# Timeout after one minute
for((t=0; t<60; t++)); do
	[ -f "$sfile" ] && break;
	sleep 1
done
tsUser=$(cat "$sfile" 2>/dev/null) # Get timestamp, user
ts=$(echo "$tsUser" | cut -d ' ' -f 1)
user=$(echo "$tsUser" | cut -d ' ' -f 2-)
tsdiff=$(($ts-$stamp))
if [ "$tsdiff" -lt -60 -o "$tsdiff" -gt 60 ]; then # Auth failed
	echo "FALSE"
else
	response="TRUE $user"
	user=$(echo "$user" | cut -d "'" -f 2)
	jqp=".[\"$user\"].ipaddr=\"$ip\" | .[\"$user\"].macaddr=\"$mac\""
	(
		flock -x 0
		jq "$jqp" <"$USERS" >"$USERS.$$" && mv "$USERS.$$" "$USERS"
		chown www-data.www-data "$USERS"
	) <"$USERS"
	echo "$response" # Sent after jq logs user in to avoid race condition
fi
mv "$sfile" "$sfile.done"
