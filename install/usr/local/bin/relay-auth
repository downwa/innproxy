#!/bin/sh

ip=$1
mac=$2
echo "awaiting auth for $ip,$mac"
stamp=$(date +%s)
sfile="/tmp/auth-$ip"
while [ ! -f "$sfile" ]; do sleep 1; done
tsUser=$(cat "$sfile") # Get timestamp, user
ts=$(echo "$tsUser" | cut -d ' ' -f 1)
user=$(echo "$tsUser" | cut -d ' ' -f 2-)
tsdiff=$(($ts-$stamp))
if [ "$tsdiff" -lt -60 -o "$tsdiff" -gt 60 ]; then # Auth failed
	echo "FALSE"
else
	echo "TRUE $user"
	user=$(echo "$user" | cut -d "'" -f 2)
	jqp=".[\"$user\"].ipaddr=\"$ip\" | .[\"$user\"].macaddr=\"$mac\""
	jq "$jqp" </var/lib/innproxy/users.json >/var/lib/innproxy/users.json.tmp && mv /var/lib/innproxy/users.json.tmp /var/lib/innproxy/users.json
fi
rm -f "$sfile"
