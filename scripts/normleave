#!/bin/bash

uid=$1
stay=$2
subset=$3
list=$4
buttons=$5

[ "$stay" == "" ] && stay=0
[ "$stay" -lt 0 ] && stay=0

# Normalize stay from 11 am of current day
[ "$stay" -gt "0" ] && stay=$((((stay-1)/86400*86400)+86400))
s=$(date --date "11:00" +%s); now=$(date +%s); stay=$((stay+s-now))

# Generate leave string
leave=$((now+stay)); leave=$(date --date "@$leave" +"11 am %a %b %d");

mstay=$((stay-86400))
[ "$mstay" -lt 0 ] && mstay=0
pstay=$((stay+86400))

[ "$stay" -lt 0 ] && stay=0
[ "$stay" = "0" ] && uid=""

# Input in /tmp/usages.csv format (usages.pl format)
while IFS=, read uid password datestamp seconds usage; do
	[ "$usage" = "" ] && usage="0.00"

	if [ "$seconds" != "3600" ]; then
		# Normalize seconds left based on 11am leave time
		secleft=$((datestamp+seconds-now+s-now))
		leaveat=$((now+secleft))
		leaveat=$(date --date "@$leaveat" +"11 am %a %b %d");
		leavesec=$(date +%s --date "$leaveat")
	fi

	[ "$datestamp" -gt 0 ] && seconds=$((leavesec-datestamp))

	echo "$uid,$password,$datestamp,$seconds,$usage"
done
