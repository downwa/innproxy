#!/bin/sh

# Block specified UID from access

[ "$1" = "" ] && echo "Missing uid" 1>&2 && exit 1
uid=$1

mostrecentip=$(grep ^ip $(grep -H ^user: /var/lib/zentyal-captiveportal/sessions/* | cut -d ':' -f 1) | awk '{print $2}')
mostrecentip=$(grep "^192.168.2..* - $uid" /var/log/zentyal-captiveportal/access.log | tail -n 1 | awk '{print $1}')
if [ "$mostrecentip" != "" ]; then
	# BLOCK further access by this MAC (allow IP as someone else may get the same IP)
	#mac=$(arp "$mostrecentip" | tail -n 1 | awk '{print $3}')
	#if [ "$mac" != "" ]; then
	#	echo iptables -I INPUT -m mac --mac-source "$mac" -j REJECT -m comment --comment "user:$uid"
	#	iptables -I INPUT -m mac --mac-source "$mac" -j REJECT -m comment --comment "user:$uid"
	#fi
	echo ip=$mostrecentip

# iptables -vnL fcaptive --line-numbers
#Chain fcaptive (1 references)
#num   pkts bytes target     prot opt in     out     source               destination         
#1        0     0 RETURN     all  --  *      *       192.168.2.68         0.0.0.0/0            MAC 1C:65:9D:31:56:CC /* user:1 */
#2      435 26292 DROP       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0           
#3        0     0 DROP       udp  --  eth0   *       0.0.0.0/0            0.0.0.0/0           
# iptables -vnL icaptive --line-numbers
#Chain icaptive (1 references)
#num   pkts bytes target     prot opt in     out     source               destination         
#1       14  2887 RETURN     all  --  *      *       192.168.2.68         0.0.0.0/0            MAC 1C:65:9D:31:56:CC /* user:1 */
#2        0     0 DROP       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0           
#3       28  3440 DROP       udp  --  eth0   *       0.0.0.0/0            0.0.0.0/0 
fi
