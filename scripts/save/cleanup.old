#!/bin/sh

[ "$1" = "" ] && echo "Missing uid" 1>&2 && exit 1
uid=$1

mostrecentip=$(uid=218; grep "^192.168.2..* - $uid" /var/log/zentyal-captiveportal/access.log | tail -n 1 | awk '{print $1}')
[ "$mostrecentip" != "" ] && mostrecentip="|$mostrecentip"

# BLOCK further access by this IP or MAC
iptables -I INPUT -s 192.168.2.68 -m mac --mac-source 1C:65:9D:31:56:CC -j REJECT -m comment --comment "user:218"
# LIST ACCESS RULES
iptables -vn -L fcaptive --line-numbers | egrep "RETURN.*(user:$uid$mostrecentip)" | awk '{print $1}' | while read line; do
	iptables -D fcaptive $line
done
# 1        0     0 RETURN     all  --  *      *       192.168.200.16       0.0.0.0/0            MAC 1C:65:9D:31:56:CC /* user:218 */
# 4        0     0 RETURN     all  --  *      *       192.168.2.68         0.0.0.0/0            MAC D4:AE:52:E8:E8:BE /* user:218 */
iptables -vn -L icaptive --line-numbers | egrep "RETURN.*(user:$uid$mostrecentip)" | awk '{print $1}' | while read line; do
	iptables -D icaptive $line
done
#1      710 76737 RETURN     all  --  *      *       192.168.2.68         0.0.0.0/0            MAC 1C:65:9D:31:56:CC /* user:218 */
#2        0     0 RETURN     all  --  *      *       192.168.200.16       0.0.0.0/0            MAC 1C:65:9D:31:56:CC /* user:218 */
