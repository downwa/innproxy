#!/bin/sh

# Logout given uid
uid=$1
[ "$uid" = "" ] && echo "Missing user id" 1>&2 && exit 1

LOG="/var/log/zentyal-captiveportal/access.log"
SESS="/var/lib/zentyal-captiveportal/sessions"
COOK="EBox::CaptivePortal::Auth_EBox="

grep -H "^user: '$uid'$" "$SESS"/* 2>/dev/null | cut -d ':' -f 1 | while read session; do
	sid=$(grep "^sid: " "$session" | awk '{print $2}')
	ip=$(grep "^ip: " "$session" | awk '{print $2}')
	cookie=$(grep "^$ip - .* .*$COOK" "$LOG" | cut -d '"' -f 10 | grep "^$COOK$sid" | head -n 1)
	printf "ip=$ip\ncookie=$cookie\n"
	for try in 1 2; do
		wget --no-check-certificate --no-cookies --header "Cookie: $cookie" "https://192.168.2.1:4443/Logout" 2>&1 | grep "403 Forbidden" && break;
		#echo wget --no-check-certificate --no-cookies --header "Cookie: $cookie" --user-agent="Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1678.0 Safari/537.36" --header "Accept-Language: en-US,en;q=0.8" --header "Http-Referer: https://192.168.2.1:4443/Popup" --header "Accept-Encoding: gzip,deflate,sdch" --header "X-Requested-With: XMLHttpRequest" "https://192.168.2.1:4443/Logout" 2>&1 #| grep "403 Forbidden" #&& break;

	done
done 

# Remove iptables rules and connection tracking
mac=$(arp "$ip" | tail -n 1 | awk '{print $3}')
conntrack -D -p tcp --src "$ip"
/sbin/iptables -t nat -D captive -s "$ip" -m mac --mac-source $mac -m comment --comment "user:$uid" -j RETURN
/sbin/iptables -D fcaptive -s "$ip" -m mac --mac-source $mac -m comment --comment "user:$uid" -j RETURN
/sbin/iptables -D icaptive -s "$ip" -m mac --mac-source $mac -m comment --comment "user:$uid" -j RETURN

exit 0

grep "^$ip - .* .*$COOK" "$LOG" | cut -d '"' -f 10 | sort | uniq | while read cookie; do
	echo "cookie=$cookie"
	for try in 1 2; do
		wget --no-check-certificate --no-cookies --header "Cookie: $cookie" "https://192.168.2.1:4443/Logout" 2>&1 | grep "403 Forbidden" && break;
	done
done

exit 0

cookie=EBox::CaptivePortal::Auth_EBox=9b4b51b1927d21699567c003afab047325ed133e40bfd5728a94ae898d126a9f
--2013-10-29 09:24:45--  https://192.168.2.1:4443/Logout
Connecting to 192.168.2.1:4443... connected.
WARNING: cannot verify 192.168.2.1's certificate, issued by `/CN=eBox Server':
  Self-signed certificate encountered.
    WARNING: certificate common name `eBox Server' doesn't match requested host name `192.168.2.1'.
HTTP request sent, awaiting response... 403 Forbidden
2013-10-29 09:24:45 ERROR 403: Forbidden.
