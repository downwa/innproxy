#!/usr/bin/perl

use strict;
use warnings;

use EBox;
use EBox::Users::User;
use Text::Password::Pronounceable;

my $datestamp = POSIX::strftime("%s", localtime);

EBox::init();

my $parent = EBox::Users::User->defaultContainer();

    my ($username, $givenname, $surname, $password, $seconds) = ($ARGV[0],$ARGV[1],$ARGV[2],$ARGV[3],$ARGV[4]);
    if($password eq "") {
	$password = uc(Text::Password::Pronounceable->generate(6,6));
    }
	printf "ADD uid=$username,seconds=$seconds\n";
	eval {
		my $cn; open INI,"/etc/innproxy.settings"; eval(<INI>);
		my $dn="uid=$username,ou=Users,".$cn;
		my $user = new EBox::Users::User(dn => $dn);
		printf("DEL: %s %s\n",$user->name,$user->description);
		$user->deleteObject();
	};
#	if ($@) { printf("DEL: %s",$@); }
	eval {
	    EBox::Users::User->create(
	        uid => $username,
		parent => $parent,
		password => $password,
		fullname => "$givenname $surname",
		givenname => $givenname,
		surname => $surname,
		description => "$password $datestamp $seconds"
	    );
	};
	if($@) {
		printf("ADD: %s",$@);
	}

1;
