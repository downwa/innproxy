#!/bin/bash

uid=$1
stay=$2
subset=$3
list=$4
buttons=$5

[ "$stay" == "" ] && stay=0
[ "$stay" -lt 0 ] && stay=0

# Normalize stay from 11 am of current day
s=$(date --date "11:00" +%s); now=$(date +%s); stay=$((stay+s-now))

# Generate leave string
leave=$((now+stay)); leave=$(date --date "@$leave" +"11 am %a %b %d");

mstay=$((stay-86400))
[ "$mstay" -lt 0 ] && mstay=0
pstay=$((stay+86400))

[ "$stay" -lt 0 ] && stay=0
[ "$stay" = "0" ] && uid=""

# FAST but inaccurate: grep "^.*,.*,0,.*,.*" /tmp/usages.csv | sort -n -k 1.6 | \

if [ "$subset" = "" ]; then
        users=$(listusers)
else
        users=$(listusers | egrep "$subset")
fi

echo "$users" | grep "^.* .* 0 .*$" | sort -n -k 1.6 | sed -e 's/ /,/g' | \
	divulate -v uid=$uid -v mstay=$mstay -v pstay=$pstay -v leave="$leave" -v stay=$stay -v ia=in -v list=$list -v buttons=$buttons
